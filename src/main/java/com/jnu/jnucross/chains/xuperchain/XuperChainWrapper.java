package com.jnu.jnucross.chains.xuperchain;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.jnu.jnucross.chains.*;
import com.jnu.jnucross.chains.xuperchain.xuper.api.Account;
import com.jnu.jnucross.chains.xuperchain.xuper.api.XuperClient;
import com.jnu.jnucross.chains.xuperchain.xuper.crypto.xchain.sign.ECKeyPair;
import com.jnu.jnucross.chains.xuperchain.xuper.pb.XchainOuterClass;
import org.web3j.protocol.core.DefaultBlockParameter;


import java.io.IOException;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author SDKany
 * @ClassName XuperChainWrapper
 * @Date 2023/8/18 22:47
 * @Version V1.0
 * @Description
 */
public class XuperChainWrapper extends ChainWrapper {
    String xuperChain_url; // = "http://10.154.24.12:8545";
    XuperClient client;// = Web3j.build(new HttpService(geth_url));
    Account account;//  = null;
    static ObjectMapper objectMapper = new ObjectMapper();

    public XuperChainWrapper(){
        super();
    }

    public XuperChainWrapper(String url, BigInteger privateKey){
        xuperChain_url = url;
        client = new XuperClient(xuperChain_url);
        ECKeyPair ecKeyPair = ECKeyPair.create(privateKey);
        account = Account.create(ecKeyPair);
    }

    public XuperChainWrapper(String url, String hexPrivateKeyString){
        xuperChain_url = url;
        client = new XuperClient(xuperChain_url);
        ECKeyPair ecKeyPair = ECKeyPair.create(Numeric.toBigInt(hexPrivateKeyString));
        account = Account.create(ecKeyPair);
    }

    public static XuperChainWrapper build(){
        XuperChainWrapper xuperChainWrapper = new XuperChainWrapper();
        xuperChainWrapper.xuperChain_url = "10.154.24.12:37101";
        xuperChainWrapper.client = new XuperClient(xuperChainWrapper.xuperChain_url);
        ECKeyPair ecKeyPair = ECKeyPair.create(new BigInteger("111497060296999106528800133634901141644446751975433315540300236500052690483486"));
        xuperChainWrapper.account = Account.create(ecKeyPair);
        return xuperChainWrapper;
    }

    @Override
    public void setChain(String url){
        client = new XuperClient(url);
    }

    @Override
    public void setAccount(String hexPrivateKeyString){
        ECKeyPair ecKeyPair = ECKeyPair.create(Numeric.toBigInt(hexPrivateKeyString));
        account = Account.create(ecKeyPair);
    }

    @Override
    public void setAccount(BigInteger privateKey){
        ECKeyPair ecKeyPair = ECKeyPair.create(privateKey);
        account = Account.create(ecKeyPair);
    }

    public static void main(String[] args) {
        ChainWrapper chainWrapper = XuperChainWrapper.build();

        System.out.println("BlockNumber = " + chainWrapper.getBlockNumber()); // 获取块高
        System.out.println("----------------------------------");
        System.out.println("The 1st block is = " + chainWrapper.getBlockByNumber(2)); // 通过块高获取块
        System.out.println("----------------------------------");
        // 通过hash获取块
        System.out.println("The block with hash 2a11f1aebb9c3ff173bbe8e1cdbf679ce72b5ca35aed50f99d3a4f6b90670d61 is = " + chainWrapper.getBlockByHash("2a11f1aebb9c3ff173bbe8e1cdbf679ce72b5ca35aed50f99d3a4f6b90670d61"));
        System.out.println("----------------------------------");
//        // 获取transaction by hash
        System.out.println("Get Transaction by hash = " + chainWrapper.getTransaction("5939f2423d45b7512d9af6ac9f56553b21d5d03f0057da407f1133dbdc4a8c86"));
        System.out.println("----------------------------------");

        //RawTransaction rawTransaction = new RawTransaction();
        //client.stop();

//        String abi = "[{\"inputs\":[{\"internalType\":\"address[]\",\"name\":\"participatingSigners\",\"type\":\"address[]\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"signerAddress\",\"type\":\"address\"}],\"name\":\"addSignatures\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"}],\"name\":\"getSigners\",\"outputs\":[{\"internalType\":\"address[]\",\"name\":\"\",\"type\":\"address[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"}],\"name\":\"getSignersSize\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"orderIndex\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"evidenceDigest\",\"type\":\"string\"}],\"name\":\"newEvidence\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"}],\"name\":\"queryEvidenceState\",\"outputs\":[{\"internalType\":\"enumEvidenceContract.State\",\"name\":\"\",\"type\":\"uint8\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"evidenceIndex\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"newState\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"evidenceDigest\",\"type\":\"string\"}],\"name\":\"updateEvidence\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]";
//        String bin = "60806040523480156200001157600080fd5b5060405162002077380380620020778339818101604052810190620000379190620002f3565b80600090805190602001906200004f92919062000057565b505062000344565b828054828255906000526020600020908101928215620000d3579160200282015b82811115620000d25782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019062000078565b5b509050620000e29190620000e6565b5090565b5b8082111562000101576000816000905550600101620000e7565b5090565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62000169826200011e565b810181811067ffffffffffffffff821117156200018b576200018a6200012f565b5b80604052505050565b6000620001a062000105565b9050620001ae82826200015e565b919050565b600067ffffffffffffffff821115620001d157620001d06200012f565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200021482620001e7565b9050919050565b620002268162000207565b81146200023257600080fd5b50565b60008151905062000246816200021b565b92915050565b6000620002636200025d84620001b3565b62000194565b90508083825260208201905060208402830185811115620002895762000288620001e2565b5b835b81811015620002b65780620002a1888262000235565b8452602084019350506020810190506200028b565b5050509392505050565b600082601f830112620002d857620002d762000119565b5b8151620002ea8482602086016200024c565b91505092915050565b6000602082840312156200030c576200030b6200010f565b5b600082015167ffffffffffffffff8111156200032d576200032c62000114565b5b6200033b84828501620002c0565b91505092915050565b611d2380620003546000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c8063147b5a7a1461006757806318b0986b146100975780638169c611146100c7578063beb0f9b5146100f7578063dfceceae14610113578063fad3682214610143575b600080fd5b610081600480360381019061007c9190610e60565b610173565b60405161008e9190610e9c565b60405180910390f35b6100b160048036038101906100ac9190610e60565b61019b565b6040516100be9190610f2e565b60405180910390f35b6100e160048036038101906100dc919061108f565b6101c8565b6040516100ee9190610e9c565b60405180910390f35b610111600480360381019061010c9190611178565b61066f565b005b61012d60048036038101906101289190610e60565b6108c2565b60405161013a9190611276565b60405180910390f35b61015d60048036038101906101589190611298565b61096c565b60405161016a9190610e9c565b60405180910390f35b6000806001600084815260200190815260200160002090508060040180549050915050919050565b60006001600083815260200190815260200160002060010160009054906101000a900460ff169050919050565b6000806001600086815260200190815260200160002090508060030183908060018154018082558091505060019003906000526020600020016000909190919091509081610216919061150b565b5060405160200161022690611634565b604051602081830303815290604052805190602001208460405160200161024d91906116a4565b604051602081830303815290604052805190602001200361029a5760018160010160006101000a81548160ff021916908360098111156102905761028f610eb7565b5b0217905550610664565b6040516020016102a990611707565b60405160208183030381529060405280519060200120846040516020016102d091906116a4565b604051602081830303815290604052805190602001200361031d5760028160010160006101000a81548160ff0219169083600981111561031357610312610eb7565b5b0217905550610663565b60405160200161032c90611768565b604051602081830303815290604052805190602001208460405160200161035391906116a4565b60405160208183030381529060405280519060200120036103a05760038160010160006101000a81548160ff0219169083600981111561039657610395610eb7565b5b0217905550610662565b6040516020016103af906117c9565b60405160208183030381529060405280519060200120846040516020016103d691906116a4565b60405160208183030381529060405280519060200120036104235760048160010160006101000a81548160ff0219169083600981111561041957610418610eb7565b5b0217905550610661565b6040516020016104329061182a565b604051602081830303815290604052805190602001208460405160200161045991906116a4565b60405160208183030381529060405280519060200120036104a65760058160010160006101000a81548160ff0219169083600981111561049c5761049b610eb7565b5b0217905550610660565b6040516020016104b59061188b565b60405160208183030381529060405280519060200120846040516020016104dc91906116a4565b60405160208183030381529060405280519060200120036105295760068160010160006101000a81548160ff0219169083600981111561051f5761051e610eb7565b5b021790555061065f565b604051602001610538906118ec565b604051602081830303815290604052805190602001208460405160200161055f91906116a4565b60405160208183030381529060405280519060200120036105ac5760078160010160006101000a81548160ff021916908360098111156105a2576105a1610eb7565b5b021790555061065e565b6040516020016105bb9061194d565b60405160208183030381529060405280519060200120846040516020016105e291906116a4565b604051602081830303815290604052805190602001200361062f5760088160010160006101000a81548160ff0219169083600981111561062557610624610eb7565b5b021790555061065d565b60098160010160006101000a81548160ff0219169083600981111561065757610656610eb7565b5b02179055505b5b5b5b5b5b5b5b849150509392505050565b60006001600084815260200190815260200160002090506060600080600080600190505b856003018054905081101561076957610754858760030183815481106106bc576106bb611962565b5b9060005260206000200180546106d19061132e565b80601f01602080910402602001604051908101604052809291908181526020018280546106fd9061132e565b801561074a5780601f1061071f5761010080835404028352916020019161074a565b820191906000526020600020905b81548152906001019060200180831161072d57829003601f168201915b5050505050610a1b565b94508080610761906119c0565b915050610693565b506000848660000154876002015460405160200161078993929190611a29565b6040516020818303038152906040528051906020012090506107aa81610bb1565b809450819550829650505050600060405180606001604052808681526020018581526020018460ff168152509050808760050160008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082015181600001556020820151816001015560408201518160020160006101000a81548160ff021916908360ff16021790555090505086600401889080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050505050505050565b606060006001600084815260200190815260200160002090508060040180548060200260200160405190810160405280929190818152602001828054801561095f57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610915575b5050505050915050919050565b600060026000815480929190610981906119c0565b919050559050600060016000838152602001908152602001600020905083816000018190555060008160010160006101000a81548160ff021916908360098111156109cf576109ce610eb7565b5b02179055508060030183908060018154018082558091505060019003906000526020600020016000909190919091509081610a0a919061150b565b504281600201819055505092915050565b606060008390506000839050600081518351610a379190611a62565b67ffffffffffffffff811115610a5057610a4f610f64565b5b6040519080825280601f01601f191660200182016040528015610a825781602001600182028036833780820191505090505b50905060008190506000805b8551811015610b1657858181518110610aaa57610aa9611962565b5b602001015160f81c60f81b838380610ac1906119c0565b945081518110610ad457610ad3611962565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080610b0e906119c0565b915050610a8e565b5060005b8451811015610ba257848181518110610b3657610b35611962565b5b602001015160f81c60f81b838380610b4d906119c0565b945081518110610b6057610b5f611962565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080610b9a906119c0565b915050610b1a565b50829550505050505092915050565b600080600080610bc4602060ff16610c0b565b85604051602001610bd6929190611b0d565b604051602081830303815290604052805190602001209050610bf781610d6a565b809450819550829650505050509193909250565b606060008203610c52576040518060400160405280600181526020017f30000000000000000000000000000000000000000000000000000000000000008152509050610d65565b6000808390505b60008114610c83578180610c6c906119c0565b925050600a81610c7c9190611b6f565b9050610c59565b60008267ffffffffffffffff811115610c9f57610c9e610f64565b5b6040519080825280601f01601f191660200182016040528015610cd15781602001600182028036833780820191505090505b5090505b60008514610d5e57600183610cea9190611ba0565b9250600a85610cf99190611bd4565b6030610d059190611a62565b60f81b818481518110610d1b57610d1a611962565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a85610d579190611b6f565b9450610cd5565b8093505050505b919050565b60008060008061303960001b90506000610d848683610da7565b90506020810151945060408101519350606081015160001a925050509193909250565b600080600080610db685610e00565b80935081945082955050505085838383604051602001610dd99493929190611c94565b6040516020818303038152906040528051906020012060001c60001b935050505092915050565b6000806000601b90508392508391509193909250565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b610e3d81610e2a565b8114610e4857600080fd5b50565b600081359050610e5a81610e34565b92915050565b600060208284031215610e7657610e75610e20565b5b6000610e8484828501610e4b565b91505092915050565b610e9681610e2a565b82525050565b6000602082019050610eb16000830184610e8d565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b600a8110610ef757610ef6610eb7565b5b50565b6000819050610f0882610ee6565b919050565b6000610f1882610efa565b9050919050565b610f2881610f0d565b82525050565b6000602082019050610f436000830184610f1f565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610f9c82610f53565b810181811067ffffffffffffffff82111715610fbb57610fba610f64565b5b80604052505050565b6000610fce610e16565b9050610fda8282610f93565b919050565b600067ffffffffffffffff821115610ffa57610ff9610f64565b5b61100382610f53565b9050602081019050919050565b82818337600083830152505050565b600061103261102d84610fdf565b610fc4565b90508281526020810184848401111561104e5761104d610f4e565b5b611059848285611010565b509392505050565b600082601f83011261107657611075610f49565b5b813561108684826020860161101f565b91505092915050565b6000806000606084860312156110a8576110a7610e20565b5b60006110b686828701610e4b565b935050602084013567ffffffffffffffff8111156110d7576110d6610e25565b5b6110e386828701611061565b925050604084013567ffffffffffffffff81111561110457611103610e25565b5b61111086828701611061565b9150509250925092565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006111458261111a565b9050919050565b6111558161113a565b811461116057600080fd5b50565b6000813590506111728161114c565b92915050565b6000806040838503121561118f5761118e610e20565b5b600061119d85828601610e4b565b92505060206111ae85828601611163565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6111ed8161113a565b82525050565b60006111ff83836111e4565b60208301905092915050565b6000602082019050919050565b6000611223826111b8565b61122d81856111c3565b9350611238836111d4565b8060005b8381101561126957815161125088826111f3565b975061125b8361120b565b92505060018101905061123c565b5085935050505092915050565b600060208201905081810360008301526112908184611218565b905092915050565b600080604083850312156112af576112ae610e20565b5b60006112bd85828601610e4b565b925050602083013567ffffffffffffffff8111156112de576112dd610e25565b5b6112ea85828601611061565b9150509250929050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061134657607f821691505b602082108103611359576113586112ff565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026113c17fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611384565b6113cb8683611384565b95508019841693508086168417925050509392505050565b6000819050919050565b60006114086114036113fe84610e2a565b6113e3565b610e2a565b9050919050565b6000819050919050565b611422836113ed565b61143661142e8261140f565b848454611391565b825550505050565b600090565b61144b61143e565b611456818484611419565b505050565b5b8181101561147a5761146f600082611443565b60018101905061145c565b5050565b601f8211156114bf576114908161135f565b61149984611374565b810160208510156114a8578190505b6114bc6114b485611374565b83018261145b565b50505b505050565b600082821c905092915050565b60006114e2600019846008026114c4565b1980831691505092915050565b60006114fb83836114d1565b9150826002028217905092915050565b611514826112f4565b67ffffffffffffffff81111561152d5761152c610f64565b5b611537825461132e565b61154282828561147e565b600060209050601f8311600181146115755760008415611563578287015190505b61156d85826114ef565b8655506115d5565b601f1984166115838661135f565b60005b828110156115ab57848901518255600182019150602085019450602081019050611586565b868310156115c857848901516115c4601f8916826114d1565b8355505b6001600288020188555050505b505050505050565b600081905092915050565b7f437573746f6d4365727469666963617465640000000000000000000000000000600082015250565b600061161e6012836115dd565b9150611629826115e8565b601282019050919050565b600061163f82611611565b9150819050919050565b60005b8381101561166757808201518184015260208101905061164c565b60008484015250505050565b600061167e826112f4565b61168881856115dd565b9350611698818560208601611649565b80840191505092915050565b60006116b08284611673565b915081905092915050565b7f546178436f6c6c65637465640000000000000000000000000000000000000000600082015250565b60006116f1600c836115dd565b91506116fc826116bb565b600c82019050919050565b6000611712826116e4565b9150819050919050565b7f496d706f72746564000000000000000000000000000000000000000000000000600082015250565b60006117526008836115dd565b915061175d8261171c565b600882019050919050565b600061177382611745565b9150819050919050565b7f6f6e506f72740000000000000000000000000000000000000000000000000000600082015250565b60006117b36006836115dd565b91506117be8261177d565b600682019050919050565b60006117d4826117a6565b9150819050919050565b7f57617265686f7573656400000000000000000000000000000000000000000000600082015250565b6000611814600a836115dd565b915061181f826117de565b600a82019050919050565b600061183582611807565b9150819050919050565b7f4c6f616465640000000000000000000000000000000000000000000000000000600082015250565b60006118756006836115dd565b91506118808261183f565b600682019050919050565b600061189682611868565b9150819050919050565b7f5369676e65640000000000000000000000000000000000000000000000000000600082015250565b60006118d66006836115dd565b91506118e1826118a0565b600682019050919050565b60006118f7826118c9565b9150819050919050565b7f526566756e646564000000000000000000000000000000000000000000000000600082015250565b60006119376008836115dd565b915061194282611901565b600882019050919050565b60006119588261192a565b9150819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006119cb82610e2a565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036119fd576119fc611991565b5b600182019050919050565b6000819050919050565b611a23611a1e82610e2a565b611a08565b82525050565b6000611a358286611673565b9150611a418285611a12565b602082019150611a518284611a12565b602082019150819050949350505050565b6000611a6d82610e2a565b9150611a7883610e2a565b9250828201905080821115611a9057611a8f611991565b5b92915050565b7f19457468657265756d205369676e6564204d6573736167653a0a000000000000600082015250565b6000611acc601a836115dd565b9150611ad782611a96565b601a82019050919050565b6000819050919050565b6000819050919050565b611b07611b0282611ae2565b611aec565b82525050565b6000611b1882611abf565b9150611b248285611673565b9150611b308284611af6565b6020820191508190509392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000611b7a82610e2a565b9150611b8583610e2a565b925082611b9557611b94611b40565b5b828204905092915050565b6000611bab82610e2a565b9150611bb683610e2a565b9250828203905081811115611bce57611bcd611991565b5b92915050565b6000611bdf82610e2a565b9150611bea83610e2a565b925082611bfa57611bf9611b40565b5b828206905092915050565b7f19457468657265756d205369676e6564204d6573736167653a0a333200000000600082015250565b6000611c3b601c836115dd565b9150611c4682611c05565b601c82019050919050565b600060ff82169050919050565b60008160f81b9050919050565b6000611c7682611c5e565b9050919050565b611c8e611c8982611c51565b611c6b565b82525050565b6000611c9f82611c2e565b9150611cab8287611af6565b602082019150611cbb8286611af6565b602082019150611ccb8285611af6565b602082019150611cdb8284611c7d565b6001820191508190509594505050505056fea2646970667358221220d31e3d1136c533cbdf2a893a35e3b5f8196280ab8e38f4167b08b238c8c1a37e64736f6c63430008120033";
//        String contractName = "EvidenceContract";
//        Map<String, String> arg = new HashMap<>();
//        arg.put("address", "[TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY]");
//        try {
//           ((XuperChainWrapper) chainWapper).account.setContractAccount("XC1234567890123258@xuper");
//           System.out.println("Contract Address : " + ((XuperChainWrapper) chainWapper).deployContract(bin, abi, contractName, arg));
//        }catch (Exception e){
//            e.printStackTrace();
//        }
        System.exit(0);

    }

    @Override
    public BigInteger getBalance(){
        try {
            return client.getBalance(account.getAddress());
        } catch (Exception e) {
            e.printStackTrace();
            return BigInteger.valueOf(0);
        }
    }

    @Override
    public long getBlockNumber() {
        return client.getHeight();
    }

    @Override
    public Block getBlockByNumber(long blockNumber) {
        XchainOuterClass.InternalBlock xuperBlock = client.queryBlockByHeight(blockNumber);
        if (xuperBlock == null)
            return new Block();
        return covertToBlock(xuperBlock);
    }

    @Override
    public Block getBlockByHash(String blockHash) {
        XchainOuterClass.InternalBlock xuperBlock = client.queryBlock(blockHash);
        if (xuperBlock == null)
            return new Block();
        return covertToBlock(xuperBlock);
    }

    @Override
    public Transaction getTransaction(String transactionHash) {
        XchainOuterClass.Transaction xuperChainTransaction = client.queryTx(transactionHash);
        if(xuperChainTransaction == null)
            return new Transaction();
        return coverToTransaction(xuperChainTransaction);
    }

//    public String deployContract(String bin, String abi, String contractName, Map<String, String> args){
//        com.jnu.jnucross.chains.xuperchain.xuper.api.Transaction t = client.deployEVMContract(account, bin.getBytes(), abi.getBytes(), contractName, args);
//        return t.getTxid();
//    }

    public Transaction transfer(String to, BigInteger amount){
        com.jnu.jnucross.chains.xuperchain.xuper.api.Transaction t =  client.transfer(account, to, amount, "1");
        return coverToTransaction(t.getRawTx());
    }

    // query不会发生交易，只请求合约上的函数
    public Transaction query(String contractName, String method, Map<String, String> args){
        com.jnu.jnucross.chains.xuperchain.xuper.api.Transaction t = client.queryEVMContract(account, contractName, method, args);;
        return coverToTransaction(t.getRawTx());
    }

    // invoke会产生交易
    public Transaction invoke(String contractName, String method, Map<String, String> args, BigInteger amount){
        com.jnu.jnucross.chains.xuperchain.xuper.api.Transaction t = client.invokeEVMContract(account, contractName, method, args, amount);
        return coverToTransaction(t.getRawTx());
    }

    public static Block covertToBlock(XchainOuterClass.InternalBlock xuperBlock){
        Block block = new Block();
        BlockHeader blockHeader = new BlockHeader();
        blockHeader.setNumber(xuperBlock.getHeight());
        blockHeader.setHash(Numeric.toHexStringNoPrefix(xuperBlock.getBlockid().toByteArray()));
        blockHeader.setPrevHash(Numeric.toHexStringNoPrefix(xuperBlock.getPreHash().toByteArray()));
        blockHeader.setReceiptRoot(Numeric.toHexStringNoPrefix(xuperBlock.getMerkleRoot().toByteArray()));
        blockHeader.setTransactionRoot(""); // xuper chain block似乎不存在这样的数据
        blockHeader.setStateRoot(""); // xuper chain block似乎不存在这样的数据
        block.setBlockHeader(blockHeader);
        block.setChainType(EnumType.ChainType.XuperChain);
        List<XchainOuterClass.Transaction> transactionResults = xuperBlock.getTransactionsList();
        List<String> transactionsHashes = new ArrayList<>();
        for (XchainOuterClass.Transaction transaction : transactionResults) {
            transactionsHashes.add(Numeric.toHexStringNoPrefix(transaction.getTxid().toByteArray()));
        }
        block.setTransactionsHashes(transactionsHashes);
        try {
            byte[] bytes = objectMapper.writeValueAsBytes(block);
            block.setRawBytes(bytes);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
            block.setRawBytes(new byte[0]);
        }
        return block;
    }

    public static Transaction coverToTransaction(XchainOuterClass.Transaction xuperChainTransaction){
        Transaction transaction = new Transaction();
        transaction.setFrom(xuperChainTransaction.getInitiator());
        try {
            transaction.setTo(Numeric.toHexStringNoPrefix(xuperChainTransaction.getTxOutputs(0).getToAddr().toByteArray()));
        }catch (Exception e){
            transaction.setTo("");
            e.printStackTrace();
        }
        transaction.setHash(Numeric.toHexStringNoPrefix(xuperChainTransaction.getTxid().toByteArray()));
        transaction.setBlockNumber(Numeric.toBigInt(xuperChainTransaction.getBlockid().toByteArray()).longValue());
        try {
            transaction.setRawBytes(xuperChainTransaction.toByteArray());
        } catch (Exception e) {
            e.printStackTrace();
            transaction.setRawBytes(new byte[0]);
        }
        transaction.setChainType(EnumType.ChainType.XuperChain);
        return transaction;
    }
}
